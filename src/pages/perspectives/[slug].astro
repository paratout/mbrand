---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase';

export async function getStaticPaths() {
  const { data: articles } = await supabase
    .from('articles')
    .select('slug')
    .eq('status', 'published');

  return (articles || []).map((article) => ({
    params: { slug: article.slug },
  }));
}

const { slug } = Astro.params;

const { data: article, error } = await supabase
  .from('articles')
  .select('*')
  .eq('slug', slug)
  .eq('status', 'published')
  .single();

if (error || !article) {
  return Astro.redirect('/404');
}

const publishDate = new Date(article.published_at || article.created_at).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<BaseLayout
  title={article.seo_title || article.title}
  description={article.seo_description || article.excerpt || ''}
  path={`/perspectives/${slug}`}
>
  <article class="article-page">
    <!-- Header -->
    <header class="article-header">
      <a href="/perspectives" class="category-badge">{article.category}</a>
      <h1 class="article-title">{article.title}</h1>
      {article.excerpt && <p class="article-excerpt">{article.excerpt}</p>}
      <div class="article-meta">
        <time datetime={article.published_at || article.created_at}>{publishDate}</time>
        {article.read_time && <><span>Â·</span><span>{article.read_time}</span></>}
      </div>
    </header>

    <!-- Cover Image -->
    {article.cover_image && (
      <div class="article-cover">
        <img src={article.cover_image} alt={article.title} />
      </div>
    )}

    <!-- Content -->
    <div class="article-content" set:html={article.content} />

    <!-- Footer -->
    <footer class="article-footer">
      <a href="/perspectives" class="back-link">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Perspectives
      </a>
    </footer>
  </article>
</BaseLayout>

<style is:global>
  /* Medium-style article headings - Clean and subtle */
  .article-content h2 {
    font-family: Georgia, 'Times New Roman', serif !important;
    font-size: 28px !important;
    font-weight: 700 !important;
    line-height: 1.3 !important;
    margin: 2em 0 0.5em !important;
    letter-spacing: -0.02em !important;
  }

  .article-content h3 {
    font-family: Georgia, 'Times New Roman', serif !important;
    font-size: 24px !important;
    font-weight: 700 !important;
    line-height: 1.4 !important;
    margin: 1.75em 0 0.5em !important;
    letter-spacing: -0.015em !important;
  }

  .article-content h4 {
    font-family: Georgia, 'Times New Roman', serif !important;
    font-size: 21px !important;
    font-weight: 700 !important;
    line-height: 1.4 !important;
    margin: 1.5em 0 0.5em !important;
  }

  .article-content h5 {
    font-family: Georgia, 'Times New Roman', serif !important;
    font-size: 19px !important;
    font-weight: 700 !important;
    line-height: 1.4 !important;
    margin: 1.5em 0 0.5em !important;
  }

  .article-content h6 {
    font-family: Georgia, 'Times New Roman', serif !important;
    font-size: 18px !important;
    font-weight: 700 !important;
    line-height: 1.4 !important;
    margin: 1.5em 0 0.5em !important;
  }
</style>

<style>
  /* Container */
  .article-page {
    max-width: 680px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* Header */
  .article-header {
    padding: 80px 0 40px;
  }

  .category-badge {
    display: inline-block;
    padding: 6px 16px;
    background: rgba(0,0,0,0.05);
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    margin-bottom: 32px;
    transition: background 0.2s;
  }

  .category-badge:hover {
    background: rgba(0,0,0,0.1);
  }

  .article-title {
    font-family: Georgia, 'Times New Roman', serif;
    font-size: 48px;
    font-weight: 700;
    line-height: 1.15;
    margin: 0 0 24px;
  }

  .article-excerpt {
    font-family: Georgia, 'Times New Roman', serif;
    font-size: 24px;
    line-height: 1.5;
    margin: 0 0 32px;
    opacity: 0.8;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    opacity: 0.6;
  }

  /* Cover Image */
  .article-cover {
    width: 100vw;
    margin-left: calc(50% - 50vw);
    margin-bottom: 64px;
    max-height: 60vh;
    overflow: hidden;
  }

  .article-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Content */
  .article-content {
    font-family: Georgia, 'Times New Roman', serif;
    font-size: 21px;
    line-height: 1.7;
    padding-bottom: 64px;
  }

  /* Hide H1 in content */
  .article-content h1 {
    display: none !important;
  }

  /* Paragraphs */
  .article-content p {
    margin: 1.4em 0;
  }

  /* Tighter spacing after headings */
  .article-content h2 + p,
  .article-content h3 + p,
  .article-content h4 + p,
  .article-content h5 + p,
  .article-content h6 + p {
    margin-top: 0.5em;
  }

  /* Drop Cap - Medium style */
  .article-content > p:first-of-type::first-letter {
    font-size: 3.2em;
    line-height: 1;
    float: left;
    margin: 0.07em 0.1em 0 0;
    font-weight: 400;
  }

  /* Links */
  .article-content a {
    color: #2563eb;
    text-decoration: underline;
  }

  /* Lists */
  .article-content ul,
  .article-content ol {
    padding-left: 30px;
    margin: 1.5em 0;
  }

  .article-content li {
    margin: 0.75em 0;
  }

  /* Blockquotes */
  .article-content blockquote {
    border-left: 4px solid currentColor;
    padding-left: 24px;
    margin: 2em 0;
    font-style: italic;
    font-size: 24px;
    opacity: 0.8;
  }

  /* Code */
  .article-content code {
    background: rgba(0,0,0,0.05);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.9em;
  }

  .article-content pre {
    background: rgba(0,0,0,0.05);
    padding: 20px;
    border-radius: 8px;
    margin: 1.5em 0;
    overflow-x: auto;
  }

  .article-content pre code {
    background: none;
    padding: 0;
  }

  /* Images */
  .article-content img {
    max-width: 100%;
    height: auto;
    margin: 2em 0;
    border-radius: 4px;
  }

  /* HR */
  .article-content hr {
    border: none;
    border-top: 1px solid currentColor;
    opacity: 0.2;
    margin: 3em 0;
  }

  /* Footer */
  .article-footer {
    padding: 32px 0 64px;
    border-top: 1px solid rgba(0,0,0,0.1);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    text-decoration: none;
    color: #2563eb;
  }

  /* Dark Mode */
  @media (prefers-color-scheme: dark) {
    .category-badge {
      background: rgba(255,255,255,0.1);
    }
    .category-badge:hover {
      background: rgba(255,255,255,0.15);
    }
    .article-content a {
      color: #60a5fa;
    }
    .article-content code,
    .article-content pre {
      background: rgba(255,255,255,0.05);
    }
    .article-footer {
      border-top-color: rgba(255,255,255,0.1);
    }
    .back-link {
      color: #60a5fa;
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .article-header {
      padding: 48px 0 32px;
    }
    .article-title {
      font-size: 36px;
    }
    .article-excerpt {
      font-size: 20px;
    }
    .article-content {
      font-size: 19px;
    }
    .article-content h2 {
      font-size: 24px !important;
      margin: 1.75em 0 0.5em !important;
    }
    .article-content h3 {
      font-size: 21px !important;
      margin: 1.5em 0 0.5em !important;
    }
    .article-content h4 {
      font-size: 19px !important;
      margin: 1.5em 0 0.5em !important;
    }
    .article-content h5,
    .article-content h6 {
      font-size: 18px !important;
      margin: 1.5em 0 0.5em !important;
    }
    .article-content blockquote {
      font-size: 21px;
    }
  }
</style>
